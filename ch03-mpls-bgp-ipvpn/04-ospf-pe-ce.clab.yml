# =============================================================================
# Lab: OSPF as a PE to CE Protocol
# Book: Versatile Routing and Services with BGP - Volume II
# Chapter: 3 - MPLS/BGP IP-VPNs
# =============================================================================
# This lab demonstrates:
# - Basic MPLS/BGP IP-VPN (RFC 4364)
# - VRF configuration with Route Targets
# - Route Distinguishers
# - MP-BGP VPNv4/VPNv6 address family
# - OSPF as PE-CE protocol with Sham-Links
# =============================================================================
#
# Topology (Figure 3-9 from book):
#
#     Area 1.0.0.0                                                 Area 2.0.0.0
#  +-----------------+                                            +------------+
#  |  CE1            |--- R1 ---------- R2 ---------- R3 ---------+    CE3     |
#  |192.168.111.0/24 | 192.0.2.1    192.0.2.2      192.0.2.3      |  192.168.  |
#  |   |             |    |             |             |           |  113.0/24  |
#  |   |  Backdoor   |    |             |    RR1      |           +------------+
#  |   |  link       |    |             |  192.0.2.10 |
#  |   |             |    |             |   /      \  |            Area 3.0.0.0
#. |   |             |    |             |  /        \ |           +------------+
#  |  CE4            |--- R4 ---------- R5 ---------- R6 ---------+    CE6     |
#  |192.168.114.0/24 |  192.0.2.4    192.0.2.5     192.0.2.6      |  192.168.  |
#  |                 |                                            |  116.0/24  |
#  +-----------------+                                            +------------+
#
# AS 64496 (Service Provider) - All routers R1-R6 and RR1
# RR1:      Route Reflector connected to R5 and R6
# IS-IS Level 2 flat area with LDP and SR-ISIS
# VPN "four" with RT 64496:4
# CE1, CE4: OSPF Area 1.0.0.0 (with backdoor link between CE1 and CE4)
# CE3:      OSPF Area 2.0.0.0
# CE6:      OSPF Area 3.0.0.0
# =============================================================================

name: ch03-ospf-pe-ce

topology:
  kinds:
    nokia_srsim:
      image: nokia_srsim:25.10.R2
      type: sr-1
      license: /opt/nokia/sros/license.txt
    linux:
      image: ghcr.io/hellt/network-multitool:latest

  nodes:
    R1:
      kind: nokia_srsim
      startup-config: configs/04/R1.partial.cfg
      
    R2:
      kind: nokia_srsim
      startup-config: configs/04/R2.partial.cfg
      
    R3:
      kind: nokia_srsim
      startup-config: configs/04/R3.partial.cfg

    R4:
      kind: nokia_srsim
      startup-config: configs/04/R4.partial.cfg
      
    R5:
      kind: nokia_srsim
      startup-config: configs/04/R5.partial.cfg
      
    R6:
      kind: nokia_srsim
      startup-config: configs/04/R6.partial.cfg
      
    # Route Reflector
    RR1:
      kind: nokia_srsim
      startup-config: configs/04/RR1.partial.cfg
      
    # Customer Edge Routers
    CE1:
      kind: nokia_srsim
      startup-config: configs/04/CE1.partial.cfg
      
    CE3:
      kind: nokia_srsim
      startup-config: configs/04/CE3.partial.cfg
      
    CE4:
      kind: nokia_srsim
      startup-config: configs/04/CE4.partial.cfg
      
    CE6:
      kind: nokia_srsim
      startup-config: configs/04/CE6.partial.cfg

  links:
    # Core links - Top row (R1-R2-R3)
    - endpoints: ["R1:1/1/c1/1", "R2:1/1/c1/1"]
    - endpoints: ["R2:1/1/c2/1", "R3:1/1/c1/1"]
    
    # Core links - Bottom row (R4-R5-R6)
    - endpoints: ["R4:1/1/c2/1", "R5:1/1/c2/1"]
    - endpoints: ["R5:1/1/c3/1", "R6:1/1/c2/1"]
    
    # Core links - connections to RR1
    - endpoints: ["R5:1/1/c4/1", "RR1:1/1/c1/1"]
    - endpoints: ["R6:1/1/c3/1", "RR1:1/1/c2/1"]
    
    # Core links - Cross connections
    - endpoints: ["R1:1/1/c2/1", "R4:1/1/c1/1"]
    - endpoints: ["R2:1/1/c3/1", "R5:1/1/c1/1"]    
    - endpoints: ["R3:1/1/c2/1", "R6:1/1/c1/1"]
    
    # PE to CE links
    - endpoints: ["R1:1/1/c3/1", "CE1:1/1/c1/1"]   # CE1: 192.168.111.0/24
    - endpoints: ["R3:1/1/c3/1", "CE3:1/1/c1/1"]   # CE3: 192.168.113.0/24
    - endpoints: ["R4:1/1/c3/1", "CE4:1/1/c1/1"]   # CE4: 192.168.114.0/24
    - endpoints: ["R6:1/1/c4/1", "CE6:1/1/c1/1"]   # CE6: 192.168.116.0/24

    # CE to CE links
    - endpoints: ["CE1:1/1/c2/1", "CE4:1/1/c2/1"]   # CE1 <-> CE4
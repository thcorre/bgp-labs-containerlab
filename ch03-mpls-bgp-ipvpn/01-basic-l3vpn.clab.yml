# =============================================================================
# Lab: MPLS/BGP IP-VPN (Layer 3 VPN)
# Book: Versatile Routing and Services with BGP - Volume II
# Chapter: 3 - MPLS/BGP IP-VPNs
# =============================================================================
# This lab demonstrates:
# - Basic MPLS/BGP IP-VPN (RFC 4364)
# - VRF configuration with Route Targets
# - Route Distinguishers
# - MP-BGP VPNv4/VPNv6 address family
# - PE-CE routing with EBGP
# - OSPF as PE-CE protocol with Sham-Links
# =============================================================================
#
# Topology (Figure 3-2 from book):
#
# CE1 ------------------|R1----------- R2 ------------ R3|------------- CE3
# 172.31.1.0/24     (192.0.2.1)   (192.0.2.2)     (192.0.2.3)      172.31.3.0/24            
# 2001:db8:4001:1::/56   |              |               |       2001:db8:4001:3::/56
#                        |              |     RR1       |
#                        |              | (192.0.2.10)  |
#                        |              | /          \  |
# CE4 ------------------|R4 ---------- R5 ------------ R6|------------- CE6
# 172.31.4.0/24     (192.0.2.4)   (192.0.2.5)     (192.0.2.6)      172.31.6.0/24
# 2001.db8.4001.4::/56                                          2001:db8:4001:6::/56
#
# AS 64496 (Service Provider) - All routers R1-R6 and RR1
# AS 64512 (Customer) - All CE routers
# IS-IS Level 2 flat area with LDP and SR-ISIS
# VPN "one" with RT 64496:1
# =============================================================================

name: ch03-mpls-bgp-ipvpn

topology:
  kinds:
    nokia_srsim:
      image: nokia_srsim:25.10.R2
      type: sr-1
      license: /opt/nokia/sros/license.txt
    linux:
      image: ghcr.io/hellt/network-multitool:latest

  nodes:
    # Provider Edge Routers
    R1:
      kind: nokia_srsim
      startup-config: configs/01/R1.partial.cfg
      
    R2:
      kind: nokia_srsim
      startup-config: configs/01/R2.partial.cfg
      
    R3:
      kind: nokia_srsim
      startup-config: configs/01/R3.partial.cfg

    R4:
      kind: nokia_srsim
      startup-config: configs/01/R4.partial.cfg
      
    R5:
      kind: nokia_srsim
      startup-config: configs/01/R5.partial.cfg
      
    R6:
      kind: nokia_srsim
      startup-config: configs/01/R6.partial.cfg
      
    # Route Reflector
    RR1:
      kind: nokia_srsim
      startup-config: configs/01/RR1.partial.cfg
      
    # Customer Edge Routers
    CE1:
      kind: linux
      
    CE3:
      kind: linux
      
    CE4:
      kind: linux
      
    CE6:
      kind: linux

  links:
    # Core links - Top row (R1-R2-R3)
    - endpoints: ["R1:1/1/c1/1", "R2:1/1/c1/1"]
    - endpoints: ["R2:1/1/c2/1", "R3:1/1/c1/1"]
    
    # Core links - Bottom row (R4-R5-R6)
    - endpoints: ["R4:1/1/c1/1", "R5:1/1/c1/1"]
    - endpoints: ["R5:1/1/c2/1", "R6:1/1/c1/1"]
    
    # Core links - connections to RR1
    - endpoints: ["R5:1/1/c3/1", "RR1:1/1/c1/1"]
    - endpoints: ["R6:1/1/c3/1", "RR1:1/1/c2/1"]
    
    # Core links - Cross connections
    - endpoints: ["R1:1/1/c2/1", "R4:1/1/c2/1"]
    - endpoints: ["R3:1/1/c2/1", "R6:1/1/c2/1"]
    
    # PE to CE links
    - endpoints: ["R1:1/1/c3/1", "CE1:eth1"]   # CE1: 172.31.1.0/24
    - endpoints: ["R3:1/1/c3/1", "CE3:eth1"]   # CE3: 172.31.3.0/24
    - endpoints: ["R4:1/1/c3/1", "CE4:eth1"]   # CE4: 172.31.4.0/24
    - endpoints: ["R6:1/1/c4/1", "CE6:eth1"]   # CE6: 172.31.6.0/24
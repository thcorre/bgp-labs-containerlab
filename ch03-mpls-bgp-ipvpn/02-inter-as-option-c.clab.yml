# =============================================================================
# Lab: Inter-AS MPLS VPN (Type B - Option B)
# Book: Versatile Routing and Services with BGP - Volume II
# Chapter: 3 - MPLS/BGP IP-VPNs (Multi-AS Backbones)
# =============================================================================
# This lab demonstrates:
# - Inter-AS Type B interconnect (EBGP VPN-IPv4 between ASBRs)
# - Next-Hop-Self on ASBRs
# - VPN label swapping at ASBRs
# - inter-as-vpn configuration
# - vpn-apply-import/export policies
# =============================================================================
#
# Topology (Figure 3-11 from book):
#
#                 AS 64496                    |                 AS 64497
#                                             |
#   CE1 ---- R1 ---- RR1 ---- ASBR1 -------- ASBR2 ---- RR2 ---- R6 ---- CE6
#            |                  |      EBGP    |                  |
#        192.0.2.1          192.0.2.2      192.0.2.5          192.0.2.6
#                          192.0.2.10                        192.0.2.11
#
# VPN "one" spans both AS with RT 64496:1
# ASBR1/ASBR2 perform VPN-IPv4 EBGP exchange with Next-Hop-Self
# =============================================================================

name: ch03-inter-as-option-c

topology:
  kinds:
    nokia_srsim:
      image: nokia_srsim:25.10.R2
      type: sr-1
      license: /opt/nokia/sros/license.txt
    linux:
      image: ghcr.io/hellt/network-multitool:latest

  nodes:
    # AS 64496
    R1:
      kind: nokia_srsim
      startup-config: configs/02-R1.cfg
      
    RR1:
      kind: nokia_srsim
      startup-config: configs/02-RR1.cfg
      
    ASBR1:
      kind: nokia_srsim
      startup-config: configs/02-ASBR1.cfg
      
    # AS 64497
    ASBR2:
      kind: nokia_srsim
      startup-config: configs/02-ASBR2.cfg
      
    RR2:
      kind: nokia_srsim
      startup-config: configs/02-RR2.cfg
      
    R6:
      kind: nokia_srsim
      startup-config: configs/02-R6.cfg
      
    # Customer Edge Routers
    CE1:
      kind: linux
      
    CE6:
      kind: linux

  links:
    # AS 64496 internal links
    - endpoints: ["R1:1/1/c1/1", "RR1:1/1/c1/1"]
    - endpoints: ["RR1:1/1/c2/1", "ASBR1:1/1/c1/1"]
    
    # Inter-AS link (EBGP)
    - endpoints: ["ASBR1:1/1/c2/1", "ASBR2:1/1/c1/1"]
    
    # AS 64497 internal links
    - endpoints: ["ASBR2:1/1/c2/1", "RR2:1/1/c1/1"]
    - endpoints: ["RR2:1/1/c2/1", "R6:1/1/c1/1"]
    
    # PE to CE links
    - endpoints: ["R1:1/1/c2/1", "CE1:eth1"]   # CE1: 172.31.1.0/24
    - endpoints: ["R6:1/1/c2/1", "CE6:eth1"]   # CE6: 172.31.6.0/24
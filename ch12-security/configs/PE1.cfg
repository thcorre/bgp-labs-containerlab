# =============================================================================
# PE1 Configuration - FlowSpec, RTBH, and Security
# Chapter 12: Security
# =============================================================================

configure {
    system {
        name "PE1"
        location "Lab - Chapter 12 - Security"
        router-id 192.0.2.1
    }
    
    card 1 {
        mda 1 {
            admin-state enable
        }
    }
    
    port 1/1/1 {
        admin-state enable
        description "to-P1-core"
        ethernet {
            mode network
        }
    }
    
    port 1/1/2 {
        admin-state enable
        description "to-Internet"
        ethernet {
            mode network
        }
    }
    
    router "Base" {
        autonomous-system 64496
        router-id 192.0.2.1
        
        interface "system" {
            ipv4 {
                primary {
                    address 192.0.2.1
                    prefix-length 32
                }
            }
            loopback true
        }
        
        interface "to-P1" {
            port 1/1/1
            ipv4 {
                primary {
                    address 10.1.1.1
                    prefix-length 30
                }
            }
        }
        
        interface "to-Internet" {
            port 1/1/2
            ipv4 {
                primary {
                    address 192.168.1.1
                    prefix-length 30
                }
            }
        }
        
        # Static route for RTBH null-route
        static-routes {
            route 192.0.2.255/32 route-type unicast {
                blackhole {
                    admin-state enable
                }
            }
        }
        
        ospf 0 {
            admin-state enable
            area 0.0.0.0 {
                interface "system" {
                    passive true
                }
                interface "to-P1" {
                    interface-type point-to-point
                }
            }
        }
        
        bgp {
            admin-state enable
            rapid-withdrawal true
            
            # FlowSpec configuration
            group "IBGP-FlowSpec" {
                peer-as 64496
                local-address 192.0.2.1
                family {
                    ipv4 true
                    flow-ipv4 true  # FlowSpec address family
                }
            }
            
            # EBGP to Internet with GTSM
            group "EBGP-Internet" {
                peer-as 64510
                family {
                    ipv4 true
                }
                # Generalized TTL Security Mechanism
                ttl-security 1
                # TCP-AO authentication
                authentication-keychain "BGP-AUTH"
            }
            
            # IBGP to core (RR)
            neighbor "192.0.2.10" {
                group "IBGP-FlowSpec"
                description "IBGP to P1/RR - FlowSpec enabled"
            }
            
            # EBGP to Internet
            neighbor "192.168.1.2" {
                group "EBGP-Internet"
                description "EBGP to Internet"
            }
        }
        
        # FlowSpec filter policy
        flowspec {
            admin-state enable
            # Embed FlowSpec rules into interface filters
            filter-embedded {
                ip-filter 100
            }
        }
    }
    
    # TCP-AO Authentication Keychain
    system {
        security {
            keychain "BGP-AUTH" {
                admin-state enable
                tcp-option-number send 254 receive 254
                entry 1 {
                    admin-state enable
                    algorithm aes-128-cmac-96
                    key "MySecretKey123"
                }
            }
        }
    }
    
    # IP Filter for FlowSpec embedding
    filter {
        ip-filter 100 {
            default-action accept
            # FlowSpec rules will be dynamically inserted here
        }
    }
    
    # RTBH Community configuration
    policy-options {
        community "RTBH" {
            member "65535:666"  # Well-known RTBH community
        }
        
        policy-statement "RTBH-policy" {
            entry 10 {
                from {
                    community {
                        name "RTBH"
                    }
                }
                action {
                    action-type accept
                    next-hop 192.0.2.255  # Null route
                }
            }
            default-action {
                action-type accept
            }
        }
    }
}
